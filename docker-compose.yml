services:
  mongodb:
    image: mongo:7.0
    container_name: research_mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: research_admin_2024
      MONGO_INITDB_DATABASE: research_collaboration
    volumes:
      - mongodb_data:/data/db
      # إذا كان init-mongo.js موجود على جهازك، أزل التعليق عن السطر التالي
      - ./setup/mongodb/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
    networks:
      - research_network
    # Healthcheck معطل لتجنب مشاكل Windows
    healthcheck:
      disable: true

  neo4j:
    image: neo4j:5.15
    container_name: research_neo4j
    restart: unless-stopped
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      NEO4J_AUTH: neo4j/research_neo4j_2024
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_security_procedures_unrestricted: apoc.*
      NEO4J_dbms_security_procedures_allowlist: apoc.*
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_plugins:/plugins
    networks:
      - research_network
    healthcheck:
      disable: true

  redis:
    image: redis:7.2-alpine
    container_name: research_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --requirepass research_redis_2024 --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - research_network
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "research_redis_2024", "ping" ]
      interval: 10s
      retries: 10
      timeout: 5s

  cassandra:
    image: cassandra:4.1
    container_name: research_cassandra
    restart: unless-stopped
    ports:
      - "9042:9042"
    environment:
      CASSANDRA_CLUSTER_NAME: Research Collaboration Cluster
      CASSANDRA_DC: ResearchDC
      CASSANDRA_RACK: Rack1
    volumes:
      - cassandra_data:/var/lib/cassandra
      - ./setup/cassandra/init-cassandra.cql:/docker-entrypoint-initdb.d/init-cassandra.cql:ro
    networks:
      - research_network
    healthcheck:
      test: [ "CMD-SHELL", "cqlsh -e 'describe keyspaces'" ]
      interval: 15s
      retries: 10
      timeout: 10s

  research-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: research_api
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./code:/app/code
      - ./tests:/app/tests
    environment:
      MONGODB_URI: mongodb://admin:research_admin_2024@mongodb:27017/research_collaboration?authSource=admin
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: research_neo4j_2024
      REDIS_URL: redis://:research_redis_2024@redis:6379
      CASSANDRA_HOST: cassandra
      CASSANDRA_PORT: 9042
    networks:
      - research_network
    depends_on:
      mongodb:
        condition: service_started
      neo4j:
        condition: service_started
      redis:
        condition: service_healthy
      cassandra:
        condition: service_started

  research-web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: research_web
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-3000}:${WEB_PORT:-3000}"
    volumes:
      - ./code:/app/code
    environment:
      WEB_PORT: ${WEB_PORT:-3000}
      MONGODB_URI: mongodb://admin:research_admin_2024@mongodb:27017/research_collaboration?authSource=admin
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: research_neo4j_2024
      REDIS_URL: redis://:research_redis_2024@redis:6379
      CASSANDRA_HOST: cassandra
      CASSANDRA_PORT: 9042
    networks:
      - research_network
    depends_on:
      mongodb:
        condition: service_started
      neo4j:
        condition: service_started
      redis:
        condition: service_healthy
      cassandra:
        condition: service_started
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    command: python code/web_interface.py

  prometheus:
    image: prom/prometheus:latest
    container_name: research_prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./docker/prometheus:/etc/prometheus
      - prometheus_data:/prometheus
    networks:
      - research_network

  grafana:
    image: grafana/grafana:latest
    container_name: research_grafana
    restart: unless-stopped
    ports:
      - "3001:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - research_network
    depends_on:
      - prometheus

volumes:
  mongodb_data:
  neo4j_data:
  neo4j_logs:
  neo4j_plugins:
  redis_data:
  cassandra_data:
  prometheus_data:
  grafana_data:


networks:
  research_network:
    driver: bridge
